name: "Test"

on: [ push, pull_request ]

# Declare default permissions as read only.
permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Install kyverno
        uses: kyverno/action-install-cli@v0.2.0

      - name: Test Policy - pass
        run: kyverno apply samples/ValidatingAdmissionPolicy.yaml --resource samples/deployment.yaml --resource samples/deployment-fail.yaml

      - name: Test Policy - fail
        continue-on-error: true
        run: kyverno apply samples/ValidatingAdmissionPolicy.yaml --resource samples/deployment-fail.yaml
